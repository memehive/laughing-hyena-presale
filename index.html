<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <!-- Serve your dApp over HTTPS for wallet connections -->
  <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Laughing Hyena Presale</title>
  <!-- Import Orbitron font for futuristic styling -->
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
  <!-- Roboto Mono for other text -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
  
  <!-- ethers.js Library (UMD build) -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <!-- Coinbase Wallet SDK -->
  <script src="https://unpkg.com/@coinbase/wallet-sdk/dist/wallet-sdk.umd.min.js"></script>
  <!-- Web3Modal (v1) for Coinbase Wallet -->
  <script src="https://unpkg.com/web3modal@1.9.8/dist/index.js"></script>
  <!-- web3 Library -->
  <script src="https://cdn.jsdelivr.net/npm/web3/dist/web3.min.js"></script>
  <!-- QRCode.js Library (optional) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  
  <style>
    /* Global Styles */
    body {
      font-family: 'Roboto Mono', monospace;
      margin: 0;
      padding: 0;
      background-color: #0D1B2A;
      color: #FFFFFF;
      text-align: center;
      font-size: 16px;
      line-height: 1.6;
    }
    h1, h2, h3 { font-family: 'Roboto Mono', monospace; }
    input, .contract-address { font-family: 'Roboto Mono', monospace; }
    /* Ensure all number inputs have the same height and placeholder style */
    input[type="number"] {
      width: 130px;
      height: 40px;
      font-size: 16px;
      line-height: 40px;
      text-align: center;
      box-sizing: border-box;
    }
    /* Label styling for input fields */
    label.input-label {
      display: block;
      font-size: 16px;
      margin-bottom: 5px;
      font-weight: bold;
      color: #FFFFFF;
    }
    .wallet-button, .buy-button, .footer-button, .warning { font-family: 'Roboto Mono', monospace; }
    .warning {
      font-size: 0.8em;
      color: #ff5555;
      margin-top: 5px;
    }
    .token-receive {
      font-weight: bold;
      color: #F0A500;
      margin-top: 10px;
    }
    .participation-box {
      background-color: #d9edf7;
      color: #0D0D0D;
      padding: 20px;
      margin: 20px 0;
      box-shadow: 0 4px 8px rgba(0,0,0,0.4);
    }
    .participation-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .participation-list li {
      margin: 12px 0;
      font-size: 1.1em;
      display: flex;
      align-items: center;
      text-align: left;
    }
    .step-icon {
      background: #F0A500;
      color: #0D1B2A;
      font-weight: bold;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      margin-right: 12px;
    }
    .wrapper {
      transition: transform 0.3s ease;
    }
    .container {
      width: 60%;
      margin: 0 auto;
      text-align: center;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    header {
      background-color: #1B263B;
      width: 100%;
      padding: 20px;
      display: flex;
      justify-content: center;
    }
    header .inner-header {
      width: 60%;
      margin: 0 auto;
    }
    header img {
      height: 150px;
      margin-bottom: 10px;
    }
    /* FUTURISTIC Header Title using Orbitron */
    .header-title {
      font-family: 'Orbitron', sans-serif;
      font-size: 3rem;
      background: linear-gradient(135deg, #F0A500, #FFD700, #FFA500);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      text-shadow: 2px 2px 6px rgba(0,0,0,0.6);
      letter-spacing: 2px;
      margin: 0;
    }
    .hero { margin-bottom: 20px; width: 100%; }
    /* Progress Bar styling: same size and centered like the status bar */
    #progress-bar {
      height: 20px;
      width: 60%;
      margin: 10px auto;
      border-radius: 10px;
      background-color: #F0A500;
      color: #0D1B2A;
      font-weight: bold;
      line-height: 20px;
      text-align: center;
    }
    /* Status Bar Styling */
    #status {
      height: 20px;
      width: 60%;
      margin: 20px auto;
      border-radius: 10px;
      background-color: #333333;
      line-height: 20px;
      text-align: center;
    }
    .status-positive { color: #28a745; }
    .status-negative { color: #ff5555; }
    #warningMessage {
      color: #ff5555;
      font-size: 14px;
      font-weight: bold;
      margin: 10px auto;
      width: 60%;
    }
    .wallet-buttons-container {
      display: flex;
      justify-content: center;
      margin: 20px auto;
      width: 60%;
      gap: 8px;
    }
    .wallet-button, .buy-button {
      background: linear-gradient(to bottom, #F0A500, #D9A300);
      color: #0D1B2A;
      font-weight: bold;
      padding: 10px 0;
      font-size: 12px;
      border-radius: 20px;
      cursor: pointer;
      border: 2px solid #000;
      transition: all 0.3s ease;
      box-shadow: 0 4px 0 #000;
      width: 150px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .buy-button {
      background: linear-gradient(to bottom, #28a745, #218838);
      font-size: 20px;
    }
    .wallet-button img, .buy-button img { margin-right: 8px; }
    .wallet-button:hover, .buy-button:hover {
      background: linear-gradient(to bottom, #D9A300, #F0A500);
      transform: translateY(2px) scale(1.05);
      box-shadow: 0 6px 10px rgba(0,0,0,0.2);
    }
    /* FUTURISTIC Buy Tokens Heading using Orbitron */
    .buy-tokens-heading {
      font-family: 'Orbitron', sans-serif;
      font-size: 2.5rem;
      background: linear-gradient(135deg, #28a745, #218838, #3CB371);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      text-shadow: 1px 1px 6px rgba(0,0,0,0.5);
      letter-spacing: 1px;
      margin-bottom: 20px;
      padding: 10px 0;
    }
    .total-raised { color: #28a745; }
    .user-contribution { color: #F0A500; }
    footer {
      background-color: #1B263B;
      width: 60%;
      margin: 20px auto;
      padding: 20px;
      text-align: center;
      font-size: 1em;
    }
    .footer-buttons {
      display: flex;
      justify-content: center;
      margin-top: 10px;
      gap: 8px;
    }
    .footer-button {
      display: flex;
      width: 100px;
      height: 25px;
      background: #F0A500;
      color: #0D1B2A;
      margin: 5px;
      border-radius: 5px;
      text-decoration: none;
      font-size: 0.8em;
      transition: background 0.3s;
      border: 2px solid #000;
      box-shadow: 0 4px 0 #000;
      align-items: center;
      justify-content: center;
    }
    .footer-button:hover { background: #D9A300; }
    .footer-logo { height: 12px; margin-right: 4px; }
    .contract-address {
      text-align: center;
      font-size: 1em;
      margin: 10px 0;
      word-wrap: break-word;
    }
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.6);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .modal {
      background: #222;
      padding: 20px;
      border-radius: 10px;
      max-width: 400px;
      width: 90%;
      text-align: center;
    }
    .modal button {
      margin-top: 15px;
      padding: 10px 20px;
      font-size: 16px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    .confirm-btn {
      background: #F0A500;
      color: #0D1B2A;
      border: 2px solid #000;
      box-shadow: 0 4px 0 #000;
    }
    .cancel-btn {
      background: #d9534f;
      color: white;
      margin-left: 10px;
      border: 2px solid #000;
      box-shadow: 0 4px 0 #000;
    }
    #disconnectWallet {
      background: linear-gradient(to bottom, #d9534f, #c9302c);
      border: 2px solid #000;
    }
    #disconnectWallet:hover {
      background: linear-gradient(to bottom, #c9302c, #d9534f);
    }
    /* Instruction Styling for Adding Token with Coinbase Wallet Download Links */
    .token-instructions {
      font-size: 0.9em;
      margin: 15px 0;
      color: #F0A500;
    }
    .token-instructions a {
      color: #4A90E2;
      text-decoration: none;
      margin: 0 5px;
      font-weight: bold;
    }
    .token-instructions a:hover {
      text-decoration: underline;
    }
    .copy-button {
      border: none;
      background: none;
      cursor: pointer;
      vertical-align: middle;
    }
    .copy-button img {
      width: 16px;
      height: 16px;
    }
    /* Autofill Text Options Styling */
    #autofillContainer {
      margin-top: 5px;
      display: none;
    }
    .autofill-option {
      display: inline-block;
      margin: 0 10px;
      color: #4A90E2;
      cursor: pointer;
      transition: color 0.2s;
    }
    .autofill-option:hover {
      text-decoration: underline;
      color: #357ABD;
    }
    /* Additional Input Field for LHyena Amount (identical styling to ETH input) */
    .conversion-container input {
      width: 130px;
      font-size: 16px;
      padding: 0.3em;
      margin: 5px;
      text-align: center;
    }
    
    /* Hide wallet balance when no wallet is connected */
    #walletBalance {
      display: none;
    }
    
    /* Media Query for Smaller Screens */
    @media (max-width: 480px) {
      body { flex-direction: column; min-height: 100vh; }
      .wrapper { transform: scale(0.9); }
      .container { width: 90%; }
      header { flex-direction: column; padding: 10px; }
      header .inner-header { width: 90%; }
      header img { height: 100px; margin-bottom: 10px; }
      header h1 { font-size: 1.2em; }
      .wallet-buttons-container, .footer-buttons {
        flex-direction: column;
        width: 90%;
        margin: 0 auto;
        justify-content: center;
        align-items: center;
      }
      #status, #progress-bar { width: 100%; }
      input[type="number"] { width: 130px; font-size: 16px; }
      footer { width: 90%; margin: 20px auto; }
      #warningMessage { width: 90%; }
      .autofill-option { margin: 5px; }
    }
  </style>
</head>
<body>
  <div class="wrapper">
    <!-- Header Section -->
    <header class="container">
      <div class="inner-header">
        <img src="https://gateway.pinata.cloud/ipfs/bafybeifvoit5z7zcwgqgkd5mf65gvktzstdsztbavsvm5x3alliyfugrwu" alt="Laughing Hyena Logo" />
        <h1 class="header-title">Laughing Hyena - $LHyena Presale</h1>
      </div>
    </header>
    
    <!-- Main Content Container -->
    <div class="container">
      <div class="hero">
        <h2>Presale Progress</h2>
        <!-- Progress bar placed under the header -->
        <div id="progress-bar">0%</div>
        <p class="total-raised">Total ETH raised: <span id="ethRaised">0</span> ETH</p>
        <p class="user-contribution">Your Contribution: <span id="userContribution">0</span> ETH</p>
        <p>Hardcap: 50 ETH | Softcap: 25 ETH | Token Rate: 20,000,000 LHyena/ETH</p>
        <p>Vesting: 25% monthly for 4 months</p>
        <p class="contract-address">
          Presale Contract Address: 
          <strong style="color: white;">0x8aaA69666D6de35561D948f6670F262F6cAC7392</strong>
          <button onclick="copyContractAddress()" class="copy-button" aria-label="Copy Presale Contract Address">
            <img src="https://gateway.pinata.cloud/ipfs/bafkreichlpjusnouyhn4jgipntvamzt6pj33dlzqoeyk6ttifo6dpjiz7q" alt="Copy Icon">
          </button>
        </p>
        <p class="warning">Warning: Do not send funds directly to the presale contract address.</p>
        <div id="warningMessage"></div>
        <div class="participation-box">
          <h2>How to Participate?</h2>
          <ol class="participation-list">
            <li><span class="step-icon">1</span>Connect your wallet (Coinbase Wallet).</li>
            <li><span class="step-icon">2</span>Enter the amount of ETH you want to contribute (max 5 ETH).</li>
            <li><span class="step-icon">3</span>Click "BUY" and confirm your transaction.</li>
          </ol>
        </div>
      </div>
      
      <!-- Status bar -->
      <div id="status" class="status-neutral">Not connected</div>
      
      <!-- Wallet Balance Paragraph (hidden by default) -->
      <p id="walletBalance">Wallet Balance: 0 ETH</p>
      
      <div class="wallet-buttons-container">
        <!-- Coinbase Wallet button -->
        <button id="connectCoinbaseWallet" class="wallet-button" onclick="connectCoinbaseWallet()" aria-label="Connect Coinbase Wallet">
          <img src="https://gateway.pinata.cloud/ipfs/bafkreigpbedcletldnqi5ue2vgh4klft5ovlltl4q47uy5qkfthxo6wfuq" alt="Coinbase Wallet Logo" width="24" height="24">
          <span>Coinbase</span>
        </button>
        <button id="disconnectWallet" class="wallet-button" onclick="disconnectWallet()" aria-label="Disconnect Wallet">
          <img src="https://gateway.pinata.cloud/ipfs/bafkreihrxilkswryoesmiwmwwlwvpcso3gtsenstcufxcwwdoq3m2yd7vm" alt="Disconnect Logo" width="24" height="24">
          <span>Disconnect</span>
        </button>
      </div>
      
      <div>
        <!-- Updated Buy Tokens Heading -->
        <h2 class="buy-tokens-heading">Buy $LHyena Tokens</h2>
        <p id="walletBalance">Wallet Balance: 0 ETH</p>
        
        <!-- Labels and Input Fields -->
        <div>
          <label class="input-label" for="ethAmount">Enter ETH</label>
          <input type="number" id="ethAmount" placeholder="ETH (Max 5)" max="5" step="0.01" onblur="validateEthAmount(); calculateTokens()">
        </div>
        <div class="conversion-container">
          <label class="input-label" for="lhyenaAmount">Enter $LHyena</label>
          <input type="number" id="lhyenaAmount" placeholder="LHyena Amount" step="any" onblur="convertLHyenaToETH();">
        </div>
        
        <!-- Autofill Options (visible after wallet connection) -->
        <div id="autofillContainer">
          <span class="autofill-option" onclick="autofillAmount(0.10)">10%</span>
          <span class="autofill-option" onclick="autofillAmount(0.25)">25%</span>
          <span class="autofill-option" onclick="autofillAmount(0.50)">50%</span>
          <span class="autofill-option" onclick="autofillAmount(1)">MAX</span>
        </div>
        <p class="token-receive">You will receive: <span id="tokenAmount">0</span> LHyena</p>
        <div class="wallet-buttons-container">
          <button id="buyTokensButton" class="buy-button" onclick="promptBuyTokens()" aria-label="Buy Tokens">
            <img src="https://gateway.pinata.cloud/ipfs/bafkreid3b6ufuleuioz3zplwxnfvl5uu4o4oafbvmma3jfiok7d6btj7fi" alt="Buy Logo" width="24" height="24">
            <span>BUY</span>
          </button>
        </div>
        <!-- Updated token instructions with Coinbase Wallet download links -->
        <p class="token-instructions">
          To add $LHyena to your Coinbase Wallet, copy the token contract address: 
          <strong style="color: white;">0x8aaA69666D6de35561D948f6670F262F6cAC7392</strong>
          <button onclick="copyTokenAddress()" class="copy-button" aria-label="Copy Token Contract Address">
            <img src="https://gateway.pinata.cloud/ipfs/bafkreichlpjusnouyhn4jgipntvamzt6pj33dlzqoeyk6ttifo6dpjiz7q" alt="Copy Icon">
          </button>
          <br>
          Don't have Coinbase Wallet? Download it from 
          <a href="https://apps.apple.com/us/app/coinbase-wallet/id1278383455" target="_blank">iOS</a> or 
          <a href="https://play.google.com/store/apps/details?id=org.toshi" target="_blank">Android</a>.
        </p>
      </div>
      
      <div id="confirmationModal" class="modal-overlay">
        <div class="modal">
          <h3>Confirm Your Transaction</h3>
          <p id="transactionSummary">You are about to contribute X ETH to receive Y LHyena tokens.</p>
          <button class="confirm-btn" onclick="confirmedBuyTokens()">Confirm Purchase</button>
          <button class="cancel-btn" onclick="closeModal()">Cancel</button>
        </div>
      </div>
    </div>
    
    <footer class="container">
      <p>&copy; 2025 Laughing Hyena. All Rights Reserved.</p>
      <div class="footer-buttons">
        <a class="footer-button" href="https://memehive.click/lhyena" target="_blank" aria-label="Visit Website">
          <img class="footer-logo" src="https://gateway.pinata.cloud/ipfs/bafkreifbwyukqegxt7il3odigkndzchztr2t55hibnyry7mlz6lbbl55jq" alt="Website Logo">Website
        </a>
        <a class="footer-button" href="https://x.com/Laughing_LHyena" target="_blank" aria-label="Visit Twitter">
          <img class="footer-logo" src="https://upload.wikimedia.org/wikipedia/commons/5/53/X_logo_2023_original.svg" alt="Twitter Logo">Twitter
        </a>
        <a class="footer-button" href="https://t.me/Laughing_LHyena" target="_blank" aria-label="Join Telegram">
          <img class="footer-logo" src="https://gateway.pinata.cloud/ipfs/bafkreihu2e3j4xjpevv77kjjonnwro3fkak7ghrtfdttgkbjg76tqeuazm" alt="Telegram Logo">Telegram
        </a>
        <a class="footer-button" href="https://www.facebook.com/share/15sZairCuW/?mibextid=wwXIfr" target="_blank" aria-label="Visit Facebook">
          <img class="footer-logo" src="https://gateway.pinata.cloud/ipfs/bafkreieghdvsc2s43xfvbetosyezg3kaukny6motwti3fz6amtqw7tatyy" alt="Facebook Logo">Facebook
        </a>
      </div>
    </footer>
  </div>
  
  <script>
    // Global variable to store wallet balance (in ETH)
    let walletBalanceRaw = 0;
    // Global variable for Coinbase disconnect timer
    let disconnectTimer = null;
    
    // Configuration Constants
    const BASE_CHAIN_ID_DEC = 8453;
    const BASECHAIN_RPC_URL = "https://base-mainnet.infura.io/v3/e923b24ca7eb4da7aa7e827ccae39ef9";
    const PRESALE_CONTRACT_ADDRESS = "0xc9beD6d7ecb7A1ea7F064A41971549FC4ee6CD20";
    const TOKEN_RATE = 20000000;
    
    // Function to convert a manually entered LHyena amount into ETH (and update the ETH field)
    function convertLHyenaToETH() {
      const lhyenaInput = document.getElementById("lhyenaAmount");
      let lhyenaVal = parseFloat(lhyenaInput.value);
      if (isNaN(lhyenaVal)) return;
      // Required ETH = LHyena amount / TOKEN_RATE
      let ethRequired = lhyenaVal / TOKEN_RATE;
      // Enforce maximum contribution of 5 ETH if necessary
      if (ethRequired > 5) {
        alert("Converted ETH exceeds maximum contribution (5 ETH).");
        ethRequired = 5;
      }
      document.getElementById("ethAmount").value = ethRequired.toFixed(2);
      calculateTokens();
    }
    
    document.addEventListener("DOMContentLoaded", function () {
      const ethers = window.ethers;
      let provider, signer;
      let userAddress = "";
      
      console.log("DOM fully loaded. Setting up Web3Modal...");
      
      const web3Modal = new window.Web3Modal.default({
        cacheProvider: false,
        providerOptions: {
          coinbasewallet: {
            package: CoinbaseWalletSDK,
            options: {
              appName: "Laughing Hyena Presale",
              rpc: BASECHAIN_RPC_URL,
              chainId: BASE_CHAIN_ID_DEC,
              darkMode: false
            }
          }
        }
      });
      
      // Helper functions for status and warning messages
      function updateStatus(message, type) {
        const statusEl = document.getElementById("status");
        statusEl.innerText = message;
        statusEl.classList.remove("status-positive", "status-negative");
        console.log("Status update:", message);
        if (type === "positive") {
          statusEl.classList.add("status-positive");
        } else if (type === "negative") {
          statusEl.classList.add("status-negative");
        }
      }
      
      function showWarning(message) {
        document.getElementById("warningMessage").innerText = message;
      }
      
      function clearWarning() {
        document.getElementById("warningMessage").innerText = "";
      }
      
      // Listen for account and chain changes
      if (window.ethereum) {
        window.ethereum.on('accountsChanged', (accounts) => {
          console.log("Accounts changed:", accounts);
          if (accounts.length > 0) {
            userAddress = accounts[0];
            updateStatus("Connected: " + userAddress, "positive");
            fetchWalletBalance();
            document.getElementById("autofillContainer").style.display = "block";
            // Show wallet balance when connected
            document.getElementById("walletBalance").style.display = "block";
          } else {
            userAddress = "";
            updateStatus("Not connected", "negative");
            document.getElementById("walletBalance").style.display = "none";
            document.getElementById("autofillContainer").style.display = "none";
          }
        });
        window.ethereum.on('chainChanged', (chainId) => {
          console.log("Chain changed to:", chainId);
          window.location.reload();
        });
      } else {
        console.warn("window.ethereum is not available. Make sure a wallet extension is installed.");
      }
      
      // Coinbase Wallet connection function using Web3Modal
      async function connectCoinbaseWallet() {
        console.log("Attempting to connect with Coinbase Wallet...");
        // If no wallet is installed, alert the user to install one.
        if (!window.ethereum) {
          updateStatus("Coinbase Wallet not detected.", "negative");
          alert("Install wallet");
          return;
        }
        web3Modal.clearCachedProvider();
        try {
          const instance = await web3Modal.connectTo("coinbasewallet");
          provider = new ethers.providers.Web3Provider(instance);
          await provider.send("eth_requestAccounts", []);
          const { chainId } = await provider.getNetwork();
          if (chainId !== BASE_CHAIN_ID_DEC) {
            updateStatus("Please connect to Basechain using Coinbase Wallet.", "negative");
            return;
          }
          signer = provider.getSigner();
          userAddress = await signer.getAddress();
          updateStatus(`Connected with Coinbase Wallet on Basechain: ${userAddress}`, "positive");
          fetchWalletBalance();
          document.getElementById("autofillContainer").style.display = "block";
          // Show wallet balance when connected
          document.getElementById("walletBalance").style.display = "block";
          // Auto-disconnect after 10 minutes
          disconnectTimer = setTimeout(() => {
            console.log("Auto-disconnect timer triggered.");
            alert("Your Coinbase wallet connection has timed out.");
            disconnectWallet();
          }, 600000);
        } catch (error) {
          console.error("Coinbase Wallet connection error:", error);
          updateStatus(`Coinbase Wallet connection failed: ${error.message}`, "negative");
        }
      }
      
      // Disconnect Wallet function: now also resets the ETH and LHyena input fields
      async function disconnectWallet() {
        console.log("Disconnecting wallet...");
        if (!provider || userAddress === "") {
          alert("No wallet connected. Please connect a wallet before trying to disconnect.");
          return;
        }
        if (provider.disconnect) {
          await provider.disconnect();
        }
        provider = null;
        signer = null;
        userAddress = "";
        updateStatus("Not connected", "negative");
        // Hide wallet balance when disconnected and clear it
        document.getElementById("walletBalance").style.display = "none";
        document.getElementById("walletBalance").innerText = "Wallet Balance: 0 ETH";
        // Reset input fields
        document.getElementById("ethAmount").value = "";
        document.getElementById("lhyenaAmount").value = "";
        document.getElementById("autofillContainer").style.display = "none";
        if (disconnectTimer) {
          clearTimeout(disconnectTimer);
          disconnectTimer = null;
        }
      }
      
      async function fetchWalletBalance() {
        if (!provider || !userAddress) return;
        try {
          const balance = await provider.getBalance(userAddress);
          walletBalanceRaw = parseFloat(ethers.utils.formatEther(balance));
          document.getElementById("walletBalance").innerText = "Wallet Balance: " + walletBalanceRaw + " ETH";
          console.log("Wallet balance updated:", walletBalanceRaw, "ETH");
        } catch (err) {
          console.error("Error fetching wallet balance:", err);
        }
      }
      
      setInterval(fetchWalletBalance, 10000);
      
      // Autofill function: calculates percentage of wallet balance (cap at 5 ETH)
      function autofillAmount(percentage) {
        if (!userAddress) {
          alert("Please connect your wallet first!");
          return;
        }
        if (walletBalanceRaw > 0) {
          let amount = walletBalanceRaw * percentage;
          if (amount > 5) { amount = 5; }
          document.getElementById("ethAmount").value = amount.toFixed(2);
          console.log("Autofill set ETH amount to:", amount.toFixed(2));
          calculateTokens();
        } else {
          alert("Wallet balance is 0. Please connect your wallet.");
        }
      }
      
      // Prompt Buy Tokens function
      function promptBuyTokens() {
        if (!signer) {
          alert("No wallet connected. Please connect your wallet before buying tokens.");
          updateStatus("Please connect your wallet first!", "negative");
          return;
        }
        validateEthAmount();
        const ethAmount = parseFloat(document.getElementById("ethAmount").value);
        if (isNaN(ethAmount)) {
          updateStatus("Please enter a valid ETH amount.", "negative");
          return;
        }
        const tokenAmount = (ethAmount * TOKEN_RATE).toLocaleString();
        document.getElementById("transactionSummary").innerText =
          `You are about to contribute ${ethAmount} ETH to receive ${tokenAmount} LHyena tokens.`;
        document.getElementById("confirmationModal").style.display = "block";
      }
      
      function closeModal() {
        document.getElementById("confirmationModal").style.display = "none";
      }
      
      async function confirmedBuyTokens() {
        closeModal();
        const { chainId } = await provider.getNetwork();
        if (chainId !== BASE_CHAIN_ID_DEC) {
          updateStatus("Incorrect network. Please switch to Basechain.", "negative");
          return;
        }
        buyTokens();
      }
      
      async function buyTokens() {
        if (!signer) {
          alert("No wallet connected. Please connect your wallet before buying tokens.");
          updateStatus("Please connect your wallet first!", "negative");
          return;
        }
        let ethAmount = parseFloat(document.getElementById("ethAmount").value);
        if (isNaN(ethAmount)) {
          updateStatus("Please enter a valid ETH amount.", "negative");
          return;
        }
        // Enforce the maximum contribution of 5 ETH
        if (ethAmount > 5) {
          alert("Maximum contribution is 5 ETH. Resetting value to 5 ETH.");
          ethAmount = 5;
          document.getElementById("ethAmount").value = "5";
          updateStatus("Maximum contribution is 5 ETH", "negative");
        }
        const contract = new ethers.Contract(
          PRESALE_CONTRACT_ADDRESS,
          [{
            "inputs": [],
            "name": "buyTokens",
            "outputs": [],
            "stateMutability": "payable",
            "type": "function"
          }],
          signer
        );
        try {
          const tx = await contract.buyTokens({ value: ethers.utils.parseEther(ethAmount.toString()) });
          updateStatus("Transaction submitted. Waiting for 3 confirmations...", "positive");
          await tx.wait(3);
          updateStatus("Transaction Successful! You have purchased $LHyena tokens.", "positive");
        } catch (error) {
          console.error("Buy tokens error:", error);
          updateStatus("Transaction failed: " + error.message, "negative");
        }
      }
      
      // Validate ETH amount (checks that it is a valid number, does not exceed 5 ETH, and does not exceed wallet balance)
      function validateEthAmount() {
        const ethInput = document.getElementById("ethAmount");
        let ethAmount = parseFloat(ethInput.value);
        if (isNaN(ethAmount)) {
          updateStatus("Please enter a valid ETH amount.", "negative");
          showWarning("Please enter a valid ETH amount.");
          return;
        }
        // Enforce maximum contribution of 5 ETH if user enters more
        if (ethAmount > 5) {
          alert("Maximum contribution is 5 ETH. Resetting value to 5 ETH.");
          ethInput.value = "5";
          ethAmount = 5;
          updateStatus("Maximum contribution is 5 ETH", "negative");
          showWarning("Maximum contribution is 5 ETH");
          return;
        }
        // Check if the entered amount exceeds the wallet balance.
        if (ethAmount > walletBalanceRaw) {
          alert("Entered amount exceeds your wallet balance (" + walletBalanceRaw.toFixed(2) + " ETH).");
          ethInput.value = walletBalanceRaw.toFixed(2);
          updateStatus("Amount reset to wallet balance", "negative");
          return;
        }
        clearWarning();
        updateStatus("", "positive");
      }
      
      // Calculate token amount based on current ETH input and update LHyena input field as well.
      function calculateTokens() {
        let ethAmount = parseFloat(document.getElementById("ethAmount").value) || 0;
        const lhyenaAmount = ethAmount * TOKEN_RATE;
        document.getElementById("tokenAmount").innerText = lhyenaAmount.toLocaleString();
        // Also update the LHyena input field for conversion reference.
        document.getElementById("lhyenaAmount").value = lhyenaAmount.toFixed(2);
        console.log("Calculated token amount for", ethAmount, "ETH is", lhyenaAmount.toLocaleString());
      }
      
      async function fetchPresaleProgress() {
        if (!provider) return;
        try {
          const contract = new ethers.Contract(
            PRESALE_CONTRACT_ADDRESS,
            [{
              "inputs": [],
              "name": "totalRaised",
              "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }],
              "stateMutability": "view",
              "type": "function"
            }],
            provider
          );
          const ethRaised = await contract.totalRaised();
          const ethRaisedFormatted = ethers.utils.formatEther(ethRaised);
          updateProgressBar(ethRaisedFormatted);
          document.getElementById("ethRaised").innerText = ethRaisedFormatted + " ETH";
        } catch (error) {
          console.error("Error fetching presale progress:", error);
        }
      }
      
      function updateProgressBar(ethRaised) {
        const hardCap = 50;
        const progress = Math.min((ethRaised / hardCap) * 100, 100);
        const progressBar = document.getElementById("progress-bar");
        // Ensure the same styling as the status bar:
        progressBar.style.width = "60%";
        progressBar.style.margin = "10px auto";
        progressBar.style.height = "20px";
        progressBar.style.borderRadius = "10px";
        progressBar.style.lineHeight = "20px";
        progressBar.style.textAlign = "center";
        progressBar.innerText = Math.round(progress) + '%';
      }
      
      setInterval(fetchPresaleProgress, 5000);
      
      // Copy functions
      function copyContractAddress() {
        const addressText = PRESALE_CONTRACT_ADDRESS;
        console.log("Copying presale contract address:", addressText);
        if (navigator.clipboard) {
          navigator.clipboard.writeText(addressText).then(() => {
            alert("Presale contract address copied to clipboard!");
          }).catch(() => {
            alert("Failed to copy presale contract address. Please try again.");
          });
        } else {
          const textArea = document.createElement("textarea");
          textArea.value = addressText;
          document.body.appendChild(textArea);
          textArea.select();
          try {
            document.execCommand("copy");
            alert("Presale contract address copied to clipboard!");
          } catch (err) {
            alert("Failed to copy presale contract address. Please try again.");
          }
          document.body.removeChild(textArea);
        }
      }
      
      function copyTokenAddress() {
        const tokenAddress = "0x8aaA69666D6de35561D948f6670F262F6cAC7392";
        console.log("Copying token contract address:", tokenAddress);
        if (navigator.clipboard) {
          navigator.clipboard.writeText(tokenAddress).then(() => {
            alert("Token contract address copied to clipboard!");
          }).catch(() => {
            alert("Failed to copy token contract address. Please try again.");
          });
        } else {
          const textArea = document.createElement("textarea");
          textArea.value = tokenAddress;
          document.body.appendChild(textArea);
          textArea.select();
          try {
            document.execCommand("copy");
            alert("Token contract address copied to clipboard!");
          } catch (err) {
            alert("Failed to copy token contract address. Please try again.");
          }
          document.body.removeChild(textArea);
        }
      }
      
      // Expose functions to the global scope for button clicks
      window.connectCoinbaseWallet = connectCoinbaseWallet;
      window.disconnectWallet = disconnectWallet;
      window.promptBuyTokens = promptBuyTokens;
      window.closeModal = closeModal;
      window.confirmedBuyTokens = confirmedBuyTokens;
      window.validateEthAmount = validateEthAmount;
      window.calculateTokens = calculateTokens;
      window.copyContractAddress = copyContractAddress;
      window.copyTokenAddress = copyTokenAddress;
      window.autofillAmount = autofillAmount;
      window.convertLHyenaToETH = convertLHyenaToETH;
      
      console.log("Setup complete.");
    });
  </script>
</body>
</html>
