<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Laughing Hyena Presale</title>
  <!-- Google Fonts: Montserrat for headings, Roboto for body text -->
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700&family=Roboto:wght@400&display=swap" rel="stylesheet">
  <!-- External Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/ethers/dist/ethers.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@walletconnect/web3-provider@1.7.8/dist/umd/index.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/web3/dist/web3.min.js"></script>
  <style>
    /* Container to ensure consistent width for key elements */
    .container {
      width: 60%;
      margin: 0 auto;
    }
    
    /* New helper class to center flex items */
    .center {
      justify-content: center !important;
    }
    
    /* Responsive styles for mobile devices */
    @media (max-width: 768px) {
      .container {
        width: 90%;
      }
      header {
        flex-direction: column;
        padding: 20px;
        text-align: center;
      }
      header img {
        max-width: 100px;
        height: auto;
        margin-bottom: 10px;
      }
      header h1 {
        font-size: 1.5em;
      }
      .wallet-buttons-container {
        flex-direction: column;
      }
      .wallet-button {
        margin: 5px 0;
        width: 100px; /* Adjust for mobile if needed */
      }
      .status, #progress-bar {
        width: 90%;
      }
    }
    
    /* Global Styles and Font Settings */
    body {
      font-family: 'Roboto', sans-serif;
      margin: 0;
      padding: 0;
      background-color: #0D1B2A;  /* Dark Navy background */
      color: #FFFFFF;
      text-align: center;
    }
    h1, h2, h3 {
      font-family: 'Montserrat', sans-serif;
    }
    
    /* Header Styling (Matches Footer Style) */
    header {
      background-color: #1B263B;  /* Deep blue matching footer */
      width: 60%;
      margin: 0 auto;
      padding: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    header img {
      height: 150px;
      margin-right: 20px;
    }
    header h1 {
      text-transform: uppercase;
      margin: 0;
    }
    
    /* Wallet Buttons Container */
    .wallet-buttons-container {
      display: flex;
      justify-content: space-between;
      margin: 20px auto;
      width: 60%;
    }
    
    /* Wallet Buttons with 3D effect, fixed width (170px), and black border */
    .wallet-button {
      background: linear-gradient(to bottom, #F0A500, #D9A300);  /* Gold gradient */
      color: #0D1B2A;  /* Dark navy text */
      font-weight: bold;
      padding: 15px 0;
      font-size: 18px;
      border-radius: 30px;
      cursor: pointer;
      border: 2px solid #000000;
      transition: all 0.3s ease;
      box-shadow: 0 4px 0 #000000;  /* 3D effect */
      width: 170px;
      margin: 0 5px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .wallet-button img {
      margin-right: 8px;
    }
    .wallet-button:hover {
      background: linear-gradient(to bottom, #D9A300, #F0A500);
      transform: translateY(2px);
      box-shadow: none;
    }
    
    /* BUY Button - Override for Green Colour with Black text */
    .buy-button {
      background: linear-gradient(to bottom, #28a745, #218838); /* Green gradient */
      color: #0D1B2A;  /* Dark navy (black-like) text */
      border: 2px solid #000000;
      box-shadow: 0 4px 0 #000000;
    }
    .buy-button:hover {
      background: linear-gradient(to bottom, #218838, #28a745);
      transform: translateY(2px);
      box-shadow: none;
    }
    
    /* Status Bar Styling */
    .status {
      margin: 20px auto;
      padding: 0 10px;
      background-color: #333333;
      border-radius: 10px;
      font-size: 1em;
      width: 60%;
      height: 20px;
      line-height: 20px;
    }
    
    /* Progress Bar Styling */
    #progress-bar {
      width: 60%;
      height: 20px;
      background-color: #F0A500;  /* Gold */
      border-radius: 10px;
      text-align: center;
      color: #0D1B2A;  /* Dark Navy text */
      line-height: 20px;
      font-weight: bold;
      margin: 20px auto;
    }
    
    /* Footer Styling */
    footer {
      background-color: #1B263B;
      padding: 20px;
      font-size: 1em;
    }
    .footer-buttons {
      margin-top: 10px;
      display: flex;
      justify-content: center;
    }
    .footer-button {
      display: flex;
      background: #F0A500;
      color: #0D1B2A;
      padding: 10px 15px;
      margin: 5px;
      border-radius: 5px;
      text-decoration: none;
      font-size: 1em;
      transition: background 0.3s;
      vertical-align: middle;
      border: 2px solid #000000;
      box-shadow: 0 4px 0 #000000;
      flex: 1;
      max-width: 120px;
      align-items: center;
      justify-content: center;
    }
    .footer-button:hover {
      background: #D9A300;
      box-shadow: none;
    }
    .footer-logo {
      height: 24px;
      vertical-align: middle;
      margin-right: 8px;
    }
    
    /* Modal styles for confirmation prompt */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.6);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .modal {
      background: #222;
      padding: 20px;
      border-radius: 10px;
      max-width: 400px;
      width: 90%;
      text-align: center;
    }
    .modal button {
      margin-top: 15px;
      padding: 10px 20px;
      font-size: 16px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    .confirm-btn {
      background: #F0A500;
      color: #0D1B2A;
      border: 2px solid #000000;
      box-shadow: 0 4px 0 #000000;
    }
    .cancel-btn {
      background: #d9534f;
      color: white;
      margin-left: 10px;
      border: 2px solid #000000;
      box-shadow: 0 4px 0 #000000;
    }
  </style>
</head>
<body>
  <!-- Header Section -->
  <header class="container">
    <img src="https://gateway.pinata.cloud/ipfs/bafybeifvoit5z7zcwgqgkd5mf65gvktzstdsztbavsvm5x3alliyfugrwu" alt="Laughing Hyena Logo" />
    <h1>Laughing Hyena - $LHyena Presale</h1>
  </header>

  <!-- Main Content Container -->
  <div class="container">
    <!-- Presale Progress and Instructions -->
    <div class="hero">
      <h2>Presale Progress</h2>
      <div id="progress-bar">0%</div>
      <p>Total ETH raised: <span id="ethRaised">0</span> ETH</p>
      <p>Your Contribution: <span id="userContribution">0</span> ETH</p>
    
      <!-- "Join the $LHyena Presale Now!" heading retains its gold shadow -->
      <h1 style="text-shadow: 3px 3px 8px #F0A500;">Join the $LHyena Presale Now!</h1>
      <p>Hardcap: 50 ETH | Softcap: 25 ETH | Token Rate: 20,000,000 LHyena/ETH</p>
      <p>Vesting: 25% monthly for 4 months</p>
      <p>Presale Contract Address: 0xc9beD6d7ecb7A1ea7F064A41971549FC4ee6CD20</p>
      <h2>How to Participate?</h2>
      <ol style="text-align: left; display: inline-block;">
        <li>Connect your wallet (MetaMask or WalletConnect).</li>
        <li>Enter the amount of ETH you want to contribute (min 0.1 ETH, max 5 ETH).</li>
        <li>Click "BUY" and confirm your transaction.</li>
      </ol>
    </div>
  
    <!-- Status Bar placed above wallet connection buttons -->
    <div id="status" class="status">Not connected</div>

    <!-- Wallet Connection Buttons in a Flex Container -->
    <div class="wallet-buttons-container">
      <button id="connectMetaMask" class="wallet-button" onclick="connectMetaMask()">
        <img src="https://metamask.io/assets/icon.svg" alt="MetaMask Logo" width="24" height="24">MetaMask
      </button>
      <button id="connectWallet" class="wallet-button" onclick="connectWalletConnect()">
        <img src="https://gateway.pinata.cloud/ipfs/bafkreica2kla4alapcinmznch47tssr2g26dpdtb3u6ltv3gzlwzmchl4a" alt="WalletConnect Logo" width="24" height="24">WalletConnect
      </button>
      <button id="disconnectWallet" class="wallet-button" onclick="disconnectWallet()">
        <img src="https://gateway.pinata.cloud/ipfs/bafkreihrxilkswryoesmiwmwwlwvpcso3gtsenstcufxcwwdoq3m2yd7vm" alt="Disconnect Logo" width="24" height="24">Disconnect
      </button>
    </div>
  
    <!-- Token Purchase Section -->
    <div>
      <h2>Buy $LHyena Tokens</h2>
      <input type="number" id="ethAmount" style="width: 150px;" placeholder="Enter ETH (Max 5ETH)" min="0.1" max="5" step="0.01" onblur="validateEthAmount(); calculateTokens()">
      <p>You will receive: <span id="tokenAmount">0</span> LHyena</p>
      <!-- BUY button in its own centered container -->
      <div class="wallet-buttons-container center">
        <button id="buyTokensButton" class="wallet-button buy-button" onclick="promptBuyTokens()">
          <img src="https://gateway.pinata.cloud/ipfs/bafkreid3b6ufuleuioz3zplwxnfvl5uu4o4oafbvmma3jfiok7d6btj7fi" alt="Buy Logo" width="24" height="24">BUY
        </button>
      </div>
    </div>
  
    <!-- Modal Confirmation Dialog -->
    <div id="confirmationModal" class="modal-overlay">
      <div class="modal">
        <h3>Confirm Your Transaction</h3>
        <p id="transactionSummary">You are about to contribute X ETH to receive Y LHyena tokens.</p>
        <button class="confirm-btn" onclick="confirmedBuyTokens()">Confirm Purchase</button>
        <button class="cancel-btn" onclick="closeModal()">Cancel</button>
      </div>
    </div>
  
    <!-- Footer with Links as Buttons with Logos -->
    <footer>
      <p>&copy; 2025 Laughing Hyena. All Rights Reserved.</p>
      <div class="footer-buttons">
        <a class="footer-button" href="https://memehive.click/lhyena" target="_blank">
          <img class="footer-logo" src="https://gateway.pinata.cloud/ipfs/bafkreifbwyukqegxt7il3odigkndzchztr2t55hibnyry7mlz6lbbl55jq" alt="Website Logo">Website
        </a>
        <a class="footer-button" href="https://x.com/Laughing_LHyena" target="_blank">
          <img class="footer-logo" src="https://gateway.pinata.cloud/ipfs/bafkreiacaeohlzwepumuvisibrwojwysaraqupy6c7p2nqdqdnpuvrzkiu" alt="Twitter Logo">Twitter
        </a>
        <a class="footer-button" href="https://t.me/Laughing_LHyena" target="_blank">
          <img class="footer-logo" src="https://gateway.pinata.cloud/ipfs/bafkreihu2e3j4xjpevv77kjjonnwro3fkak7ghrtfdttgkbjg76tqeuazm" alt="Telegram Logo">Telegram
        </a>
        <a class="footer-button" href="https://www.facebook.com/share/15sZairCuW/?mibextid=wwXIfr" target="_blank">
          <img class="footer-logo" src="https://gateway.pinata.cloud/ipfs/bafkreieghdvsc2s43xfvbetosyezg3kaukny6motwti3fz6amtqw7tatyy" alt="Facebook Logo">Facebook
        </a>
      </div>
    </footer>
  </div> <!-- End of container -->

  <script>
    // ---------------- Configuration Constants ----------------
    const BASE_CHAIN_ID_DEC = 8453;
    const BASE_CHAIN_ID_HEX = '0x2105';
    // Replace with your actual Basechain RPC endpoint
    const BASECHAIN_RPC_URL = "https://base-mainnet.infura.io/v3/e923b24ca7eb4da7aa7e827ccae39ef9";
    // Replace with your deployed presale contract address
    const PRESALE_CONTRACT_ADDRESS = "0xc9beD6d7ecb7A1ea7F064A41971549FC4ee6CD20";
    // Set TOKEN_RATE to match the contract: 20,000,000 LHyena per 1 ETH
    const TOKEN_RATE = 20000000;

    // ---------------- Global Variables ----------------
    let provider, signer;
    let walletConnectProvider;
    let userAddress = "";

    // ---------------- UI Helper ----------------
    function updateStatus(message) {
      document.getElementById("status").innerText = message;
    }

    // ---------------- Helper Functions ----------------
    async function ensureNetwork(currentProvider) {
      const network = await currentProvider.getNetwork();
      console.log("Connected chainId:", network.chainId);
      if (network.chainId !== BASE_CHAIN_ID_DEC) {
        try {
          await window.ethereum.request({
            method: 'wallet_switchEthereumChain',
            params: [{ chainId: BASE_CHAIN_ID_HEX }]
          });
          return new ethers.providers.Web3Provider(window.ethereum);
        } catch (error) {
          throw new Error("Failed to switch to Basechain. Please switch manually.");
        }
      }
      return currentProvider;
    }

    // ---------------- Wallet Event Listeners ----------------
    if (window.ethereum) {
      window.ethereum.on('accountsChanged', (accounts) => {
        if (accounts.length > 0) {
          userAddress = accounts[0];
          updateStatus("Connected: " + userAddress);
        } else {
          userAddress = "";
          updateStatus("Not connected");
        }
      });
      window.ethereum.on('chainChanged', (chainId) => {
        window.location.reload();
      });
    }

    // ---------------- Wallet Connection Functions ----------------
    async function connectMetaMask() {
      if (window.ethereum) {
        try {
          await window.ethereum.request({ method: 'eth_requestAccounts' });
          let tempProvider = new ethers.providers.Web3Provider(window.ethereum);
          tempProvider = await ensureNetwork(tempProvider);
          const tempSigner = tempProvider.getSigner();
          const address = await tempSigner.getAddress();
          updateStatus("Connected to MetaMask on Basechain: " + address);
          provider = tempProvider;
          signer = tempSigner;
          userAddress = address;
        } catch (error) {
          console.error(error);
          updateStatus("MetaMask connection failed: " + error.message);
        }
      } else {
        updateStatus("No Ethereum provider found. Please install MetaMask.");
      }
    }

    async function connectWalletConnect() {
      try {
        walletConnectProvider = new WalletConnectProvider.default({
          rpc: { 
            [BASE_CHAIN_ID_DEC]: BASECHAIN_RPC_URL 
          },
          chainId: BASE_CHAIN_ID_DEC,
        });
        await walletConnectProvider.enable();
        provider = new ethers.providers.Web3Provider(walletConnectProvider);
        const network = await provider.getNetwork();
        if (network.chainId !== BASE_CHAIN_ID_DEC) {
          updateStatus("Please connect to Basechain using your WalletConnect wallet.");
          return;
        }
        signer = provider.getSigner();
        userAddress = await signer.getAddress();
        updateStatus("Connected with WalletConnect on Basechain: " + userAddress);
      } catch (error) {
        console.error(error);
        updateStatus("WalletConnect connection failed: " + error.message);
      }
    }

    // Disconnect the wallet; prompt if no wallet is connected.
    async function disconnectWallet() {
      if (!provider || userAddress === "") {
        alert("No wallet connected");
        return;
      }
      if (walletConnectProvider && walletConnectProvider.disconnect) {
        await walletConnectProvider.disconnect();
      }
      provider = null;
      signer = null;
      userAddress = "";
      updateStatus("Not connected");
    }

    // ---------------- Modal Confirmation for Purchase ----------------
    function promptBuyTokens() {
      // Check if wallet is connected before showing confirmation
      if (!signer) {
        alert("Please connect your wallet first!");
        updateStatus("Please connect your wallet first!");
        return;
      }
      validateEthAmount();
      const ethAmount = parseFloat(document.getElementById("ethAmount").value);
      if (!ethAmount || ethAmount < 0.1 || ethAmount > 5) {
        updateStatus("Contribution must be between 0.1 and 5 ETH.");
        return;
      }
      const tokenAmount = (ethAmount * TOKEN_RATE).toLocaleString();
      document.getElementById("transactionSummary").innerText =
        `You are about to contribute ${ethAmount} ETH to receive ${tokenAmount} LHyena tokens.`;
      document.getElementById("confirmationModal").style.display = "flex";
    }

    function closeModal() {
      document.getElementById("confirmationModal").style.display = "none";
    }

    async function confirmedBuyTokens() {
      closeModal();
      const network = await provider.getNetwork();
      if (network.chainId !== BASE_CHAIN_ID_DEC) {
        updateStatus("Incorrect network. Please switch to Basechain.");
        return;
      }
      buyTokens();
    }

    // ---------------- Token Purchase Functions ----------------
    async function buyTokens() {
      if (!signer) {
        alert("Please connect your wallet first!");
        updateStatus("Please connect your wallet first!");
        return;
      }
      let ethAmount = parseFloat(document.getElementById("ethAmount").value);
      if (ethAmount < 0.1 || ethAmount > 5) {
        updateStatus("Contribution must be between 0.1 and 5 ETH.");
        return;
      }
      const contract = new ethers.Contract(
        PRESALE_CONTRACT_ADDRESS,
        [
          {
            "inputs": [],
            "name": "buyTokens",
            "outputs": [],
            "stateMutability": "payable",
            "type": "function"
          }
        ],
        signer
      );
      try {
        const tx = await contract.buyTokens({ value: ethers.utils.parseEther(ethAmount.toString()) });
        updateStatus("Transaction submitted. Waiting for 3 confirmations...");
        await tx.wait(3);
        updateStatus("Transaction Successful! You have purchased $LHyena tokens.");
      } catch (error) {
        console.error(error);
        updateStatus("Transaction failed: " + error.message);
      }
    }

    // ---------------- Validation Functions ----------------
    function validateEthAmount() {
      const ethInput = document.getElementById("ethAmount");
      let ethAmount = parseFloat(ethInput.value);
      if (isNaN(ethAmount)) {
        updateStatus("Please enter a valid ETH amount.");
        return;
      }
      if (ethAmount > 5) {
        alert("Maximum contribution per wallet is 5 ETH");
        ethInput.value = 5;
        updateStatus("Maximum contribution per wallet is 5 ETH");
      } else if (ethAmount < 0.1 && ethInput.value !== "") {
        alert("Minimum contribution is 0.1 ETH");
        ethInput.value = 0.1;
        updateStatus("Minimum contribution is 0.1 ETH");
      } else {
        updateStatus("");
      }
    }

    function calculateTokens() {
      let ethAmount = parseFloat(document.getElementById("ethAmount").value) || 0;
      document.getElementById("tokenAmount").innerText = (ethAmount * TOKEN_RATE).toLocaleString();
    }

    // ---------------- Progress Bar Functions ----------------
    async function fetchPresaleProgress() {
      if (!provider) return;
      try {
        const contract = new ethers.Contract(
          PRESALE_CONTRACT_ADDRESS,
          [
            {
              "inputs": [],
              "name": "totalRaised",
              "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }],
              "stateMutability": "view",
              "type": "function"
            }
          ],
          provider
        );
        const ethRaised = await contract.totalRaised();
        const ethRaisedFormatted = ethers.utils.formatEther(ethRaised);
        updateProgressBar(ethRaisedFormatted);
        document.getElementById("ethRaised").innerText = ethRaisedFormatted;
      } catch (error) {
        console.error("Error fetching presale progress:", error);
      }
    }

    function updateProgressBar(ethRaised) {
      const hardCap = 50;
      const progress = Math.min((ethRaised / hardCap) * 100, 100);
      const progressBar = document.getElementById("progress-bar");
      progressBar.style.width = progress + '%';
      progressBar.innerText = Math.round(progress) + '%';
    }

    // Poll presale progress every 5 seconds
    setInterval(fetchPresaleProgress, 5000);
  </script>
</body>
</html>
